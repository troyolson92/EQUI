@model EqUiWebUi.Models.LogInfo
<div class="panel panel-default">
    <div class="panel-heading">
        <h5>Trend for @Model.logtext on @Model.location</h5>
    </div>

    <div class="panel-body" id="graphSpinner" style="position:relative">
        <div id="gaphContainer">
            <canvas id='graphCanvas'></canvas>
        </div>
    </div>

    <div class="panel-footer">
        <div class="row">
            <div class=" col-sm-2">
                Groupmode
            </div>

            <div class="col-sm-4">
                <div class="btn-group" id="btnGrouping" role="group" aria-label="Graph grouping mode">
                    <button type="button" class="btn  btn-sm btn-secondary active" id="btnGroupingAuto">auto</button>
                    <button type="button" class="btn  btn-sm btn-secondary" id="btnGroupingHour">hour</button>
                    <button type="button" class="btn  btn-sm btn-secondary" id="btnGroupingDay">day</button>
                    <button type="button" class="btn  btn-sm btn-secondary" id="btnGroupingWeek">week</button>
                    <button type="button" class="btn  btn-sm btn-secondary" id="btnGroupingMonth">month</button>
                </div>
            </div>

            <div class="col-sm-3"></div>

            <div class="col-sm-4 col-sm-offset-2">
                <div class="row">
                    <div class="col-sm-4">
                        <h5>Date range</h5>
                    </div>
                    <div class="col-sm-8">
                        <input type="text" id="demo" class="form-control input-sm">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script src="~/Scripts/d3/d3.js"></script>
<script src="~/Scripts/d3/Chart.bundle.js"></script>
<script>
    //global vars
    var groupmode = 0;
    var endDate = moment().subtract(29, 'days');
    var startDate = moment();
    var spinnerErrorTrent = new Spinner();
    var ErrorTrendChart;

    //get chart data
    function getChartData(_location, _errornum, _logtekst, _logtype, _startDate, _endDate, _groupType) {
        //start a wait spinner
        spinnerErrorTrent.spin(document.getElementById('graphSpinner'));
        //make ajax request
        $.ajax({
            type: 'GET',
            url: "/chart/_getData" +
            "?location=" + _location
            + "&errornum=" + _errornum
            + "&logtekst=" + _logtekst
            + "&logtype=" + _logtype
            + "&startDate=" + _startDate
            + "&endDate=" + _endDate
            + "&grouptType=" + _groupType,
            data: JSON.stringify(),
            success: function (returnPayload) {
                console && console.log("request succeeded");
                buildchart(returnPayload, "chartName");
                //hide spinner when completes
                spinnerErrorTrent.stop();
            },
            error: function (xhr, ajaxOptions, thrownError) {
                console && console.log("request failed!!");
                $("#gaphContainer").html('<div>Request failed!!</div>');
                spinnerErrorTrent.stop();
            },
            dataType: "json",
            contentType: "application/json",
            processData: false,
            async: true
        });
    };


    //build the chart Calls when ajax request ends
    function buildchart(table, chartName) {
        var vLabels = new Array();
        var vData = new Array();

        for (var i = table.length - 1; i >= 0; i--) {
            vLabels.push(table[i].Label);
            vData.push(table[i].Count)
        }

        var config = {
            type: 'bar',
            data: {
                labels: vLabels,
                datasets: [{
                    yAxisID: 'A',
                    position: 'left',
                    label: "Count of fault",
                    backgroundColor: '#2F7CCA',
                    borderColor: '#2F7CCA',
                    data: vData,
                    fill: false,
                }
                ]
            },
            options: {
                responsive: true,
                legend: {
                    display: false //nolegend
                },
                title: {
                    display: false, //display name off!
                    text: chartName
                },
                tooltips: {
                    mode: 'index',
                    intersect: false,
                },
                hover: {
                    mode: 'nearest',
                    intersect: true
                },
                scales: {
                    xAxes: [{
                        display: true,
                        scaleLabel: {
                            display: false, //x label off
                            labelString: '[Time]'
                        }
                    }],
                    yAxes: [{
                        display: true,
                        id: 'A',
                        ticks: {
                            beginAtZero: true,
                            // steps: 10,
                            // stepValue: 5,
                            //max: 200,
                        },
                        scaleLabel: {
                            display: true,
                            labelString: ' [Count]'
                        }
                    }]
                }
            }
        };
        //destroy chart if exists
        if (ErrorTrendChart) {
            ErrorTrendChart.destroy();
        }
        //clear the cancas just to be shure
        $("#graphCanvas").remove(); 
        //add the new canvas
        $("#gaphContainer").append('<canvas id="graphCanvas" height="70"></canvas>');
        //build the chart
        var ctx = document.getElementById("graphCanvas").getContext("2d");
        ErrorTrendChart = new Chart(ctx, config);
    }


    //refresh the chart
    function refreshChart() {
        getChartData("@Model.location", @Model.errornum, "@Model.logtext", "@Model.logtype", moment(startDate).toISOString(), moment(endDate).toISOString(), groupmode);
    };


    //setting up datetimePicker
    $('#demo').daterangepicker({
        "showWeekNumbers": true,
        "showISOWeekNumbers": true,
        "ranges": {
            'Today': [moment(), moment()],
            'Last 48 Hours': [moment().subtract(2, 'days'), moment()],
            'Last 7 Days': [moment().subtract(6, 'days'), moment()],
            'Last 30 Days': [moment().subtract(29, 'days'), moment()],
            'Last 100 Days': [moment().subtract(100, 'days'), moment()],
            'Last Year': [moment().subtract(365, 'days'), moment()]
        },
        "startDate": startDate,
        "endDate": endDate,
        "opens": "left",
        "drops": "up"
    }, function (end, start, label) {
        console.log("New date range selected: " + start.format('YYYY-MM-DD') + " to " + end.format('YYYY-MM-DD') + " (predefined range: " + label + ")");
        startDate = start;
        endDate = end;
        refreshChart();
        });

    
    //setting up groupmode events
    $("#btnGroupingAuto").click(function () {
        $("#btnGrouping").find(".active").removeClass("active");
        $("#btnGroupingAuto").addClass("active");
        groupmode = 0;
        refreshChart();
    });

    $("#btnGroupingHour").click(function () {
        $("#btnGrouping").find(".active").removeClass("active");
        $("#btnGroupingHour").addClass("active");
        groupmode = 1;
        refreshChart();
    });

    $("#btnGroupingDay").click(function () {
        $("#btnGrouping").find(".active").removeClass("active");
        $("#btnGroupingDay").addClass("active");
        groupmode = 2;
        refreshChart();
    });

    $("#btnGroupingWeek").click(function () {
        $("#btnGrouping").find(".active").removeClass("active");
        $("#btnGroupingWeek").addClass("v");
        groupmode = 3;
        refreshChart();
    });

    $("#btnGroupingMonth").click(function () {
        $("#btnGrouping").find(".active").removeClass("active");
        $("#btnGroupingMonth").addClass("active");
        groupmode = 4;
        refreshChart();
    });
    //init on doc loaded done
    $(document).ready(function () {
        refreshChart();
    });
</script>

